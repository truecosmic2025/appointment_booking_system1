{% extends "base.html" %}
{% block title %}Availability Settings | TrueCosmic Calendar{% endblock %}
{% block content %}
<section class="py-12">
  <div class="mx-auto max-w-3xl px-4">
    <h1 class="text-3xl font-bold text-slate-900">Availability settings</h1>
    <p class="text-slate-600 mt-1">Set your time zone and working hours. Visitors will see times in their own time zone.</p>

    <form method="post" class="mt-6 space-y-6">
      <div class="grid grid-cols-1 gap-3">
        <label class="text-sm font-medium text-slate-700">Time zone</label>
        <input name="timezone" id="timezone" value="{{ tz }}" list="tzlist" class="rounded-md border border-slate-300 px-3 py-2" />
        <datalist id="tzlist"></datalist>
        <p class="text-xs text-slate-500">Tip: Your browser time zone is auto-detected below; you can copy it into this field.</p>
        <div class="text-xs text-slate-600">Detected: <span id="detectedTz">...</span></div>
      </div>

      <div>
        <div class="text-sm font-medium text-slate-700">Working hours (per day)</div>
        <div class="mt-2 space-y-2 text-sm">
          {% for d, label in [('mon','Mon'),('tue','Tue'),('wed','Wed'),('thu','Thu'),('fri','Fri'),('sat','Sat'),('sun','Sun')] %}
            {% set ranges = hours.get(d, []) %}
            <div class="border rounded-md p-2">
              <div class="flex items-center justify-between">
                <label class="inline-flex items-center gap-2"><input type="checkbox" name="day" value="{{ d }}" {% if d in selected_days %}checked{% endif %}> {{ label }}</label>
                <button type="button" class="text-xs rounded-md border border-slate-300 px-2 py-1" onclick="addRange('{{ d }}')">Add range</button>
              </div>
              <div id="ranges_{{ d }}" class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                {% for r in ranges %}
                  <div class="flex items-center gap-2">
                    <input type="time" name="start_{{ d }}" value="{{ r[0] }}" class="rounded-md border border-slate-300 px-2 py-1" />
                    <span>–</span>
                    <input type="time" name="end_{{ d }}" value="{{ r[1] }}" class="rounded-md border border-slate-300 px-2 py-1" />
                    <button type="button" class="text-xs rounded-md border border-red-300 bg-red-50 px-2 py-1 text-red-700" onclick="this.parentElement.remove()">Remove</button>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium text-slate-700">Buffer (minutes)</label>
          <input type="number" min="0" name="buffer_min" value="{{ buffer_min }}" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Min notice (minutes)</label>
          <input type="number" min="0" name="min_notice_min" value="{{ min_notice_min }}" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Max days ahead</label>
          <input type="number" min="1" name="max_days_ahead" value="{{ max_days_ahead }}" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" />
        </div>
      </div>

      <div>
        <button class="rounded-md bg-slate-900 px-4 py-2 text-white font-semibold">Save settings</button>
        <a href="{{ url_for('dashboard.host') }}" class="ml-2 text-sm text-slate-700 hover:underline">Back to dashboard</a>
      </div>
    </form>
  </div>
</section>
<script>
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  document.getElementById('detectedTz').textContent = tz || 'Unavailable';
  // Populate IANA time zones in datalist (client-side search)
  try {
    const zones = (Intl.supportedValuesOf && Intl.supportedValuesOf('timeZone')) || [];
    const dl = document.getElementById('tzlist');
    if (dl && zones.length) {
      zones.forEach(z => { const o = document.createElement('option'); o.value = z; dl.appendChild(o); });
    } else if (dl) {
      // Fallback small set
      ['UTC','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','Europe/London','Europe/Berlin','Asia/Kolkata','Asia/Tokyo','Australia/Sydney'].forEach(z=>{const o=document.createElement('option');o.value=z;dl.appendChild(o);});
    }
  } catch (e) {}

  function addRange(day){
    const wrap = document.getElementById('ranges_'+day);
    const row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    row.innerHTML = `
      <input type="time" name="start_${day}" class="rounded-md border border-slate-300 px-2 py-1" />
      <span>–</span>
      <input type="time" name="end_${day}" class="rounded-md border border-slate-300 px-2 py-1" />
      <button type="button" class="text-xs rounded-md border border-red-300 bg-red-50 px-2 py-1 text-red-700" onclick="this.parentElement.remove()">Remove</button>
    `;
    wrap.appendChild(row);
  }
</script>
{% endblock %}
