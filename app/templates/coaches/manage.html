{% extends "base.html" %}
{% block title %}Manage Booking | TrueCosmic Calendar{% endblock %}
{% block content %}
<section class="py-16">
  <div class="mx-auto max-w-xl px-4">
    <h1 class="text-2xl font-bold text-slate-900">Manage your booking</h1>
    <div class="mt-4 rounded-lg border border-slate-200 bg-white p-6">
      <div class="text-sm text-slate-600">Coach: <span class="font-medium text-slate-900">{{ coach.name }}</span></div>
      <div class="text-sm text-slate-600">Visitor: <span class="font-medium text-slate-900">{{ booking.visitor_name }} ({{ booking.visitor_email }})</span></div>
      <div class="text-sm text-slate-600">Start (UTC): <span class="font-medium text-slate-900">{{ booking.start_utc }}</span></div>
      <div class="text-sm text-slate-600">Status: <span class="font-medium text-slate-900">{{ booking.status }}</span></div>
      {% if booking.meet_link %}
      <div class="mt-3"><a href="{{ booking.meet_link }}" target="_blank" class="text-brand-700 underline">Join Google Meet</a></div>
      {% endif %}
      {% if booking.status != 'cancelled' %}
      <div class="mt-6">
        <label class="block text-sm font-medium text-slate-700">Reschedule to</label>
        <input id="newDate" type="date" class="mt-1 rounded-md border border-slate-300 px-2 py-1 text-sm">
        <div id="newSlots" class="mt-2 grid grid-cols-3 gap-2"></div>
      </div>
      <form id="cancelForm" class="mt-6">
        <button class="rounded-md border border-red-300 bg-red-50 px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-100">Cancel booking</button>
      </form>
      {% endif %}
    </div>
  </div>
</section>
<script>
document.getElementById('cancelForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const res = await fetch(location.pathname + '/cancel', {method:'POST'});
  const data = await res.json();
  if(data.ok){ location.reload(); }
});

// Reschedule helper: reuse availability API from the coach
const slug = {{ profile.slug|tojson }}
const newDate = document.getElementById('newDate');
const newSlots = document.getElementById('newSlots');
newDate && (newDate.valueAsDate = new Date());
async function loadNewSlots(){
  if(!newDate) return;
  newSlots.innerHTML = '';
  const res = await fetch(`/api/availability/${slug}?date=${newDate.value}`);
  const data = await res.json();
  (data.slots||[]).forEach(s=>{
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='rounded-md border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50';
    const dt = new Date(s);
    btn.textContent = dt.toUTCString().slice(17,22) + ' UTC';
    btn.onclick = async ()=>{
      const r = await fetch(location.pathname + '/reschedule', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({start: s})});
      const d = await r.json();
      if(d.ok){ location.reload(); }
    };
    newSlots.appendChild(btn);
  });
}
newDate && newDate.addEventListener('change', loadNewSlots);
loadNewSlots();
</script>
{% endblock %}
