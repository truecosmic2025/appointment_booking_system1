{% extends "base.html" %}
{% block title %}Book {{ coach.name }} | TrueCosmic Calendar{% endblock %}
{% block content %}
<section class="py-16">
  <div class="mx-auto max-w-5xl px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
    <div>
      <div class="rounded-lg border border-slate-200 bg-white p-6">
        <div class="text-slate-900 font-semibold">{{ coach.name }}</div>
        <div class="text-sm text-slate-600">30-minute session</div>
        <div class="mt-3 text-xs text-slate-500">Google Calendar{% if not profile.google_credentials %} not{% endif %} connected</div>
      </div>
    </div>
    <div class="md:col-span-2">
      <div class="rounded-lg border border-slate-200 bg-white p-6">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Pick a date</h2>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500">All times in</span>
            <select id="tzSelect" class="rounded-md border border-slate-300 px-2 py-1 text-xs"></select>
            <input id="date" type="date" class="rounded-md border border-slate-300 px-2 py-1 text-sm" />
          </div>
        </div>
        <div id="slots" class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        <form id="bookForm" class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3 hidden">
          <input type="text" name="name" placeholder="Your name" class="rounded-md border border-slate-300 px-3 py-2" required>
          <input type="email" name="email" placeholder="Your email" class="rounded-md border border-slate-300 px-3 py-2" required>
          <button class="rounded-md bg-slate-900 px-4 py-2 text-white">Book 30 min</button>
        </form>
        <div id="result" class="mt-4 text-sm"></div>
      </div>
    </div>
  </div>
</section>
<script>
const slug = {{ profile.slug|tojson }}
const dateInput = document.getElementById('date');
const slotsEl = document.getElementById('slots');
const bookForm = document.getElementById('bookForm');
const resultEl = document.getElementById('result');
let selectedStart = null;
const tzSelect = document.getElementById('tzSelect');

function initTzSelect(){
  const detected = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  const opts = [detected, 'UTC'];
  tzSelect.innerHTML = '';
  opts.forEach(tz=>{
    const o = document.createElement('option');
    o.value = tz; o.textContent = tz; tzSelect.appendChild(o);
  });
}

dateInput.valueAsDate = new Date();
initTzSelect();

async function loadSlots(){
  slotsEl.innerHTML = '<div class="text-slate-500">Loading...</div>';
  const d = dateInput.value || new Date().toISOString().substring(0,10);
  const res = await fetch(`/api/availability/${slug}?date=${d}`);
  const data = await res.json();
  const slots = data.slots || [];
  if(!slots.length){
    slotsEl.innerHTML = '<div class="text-slate-500">No available slots for this day.</div>';
    bookForm.classList.add('hidden');
    return;
  }
  slotsEl.innerHTML = '';
  slots.forEach(s => {
    const dt = new Date(s);
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'rounded-md border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50';
    const tz = tzSelect.value || Intl.DateTimeFormat().resolvedOptions().timeZone;
    const label = dt.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit', timeZone: tz});
    btn.textContent = label;
    btn.onclick = () => { selectedStart = s; bookForm.classList.remove('hidden'); [...slotsEl.children].forEach(c=>c.classList.remove('ring-2','ring-brand-500')); btn.classList.add('ring-2','ring-brand-500'); }
    slotsEl.appendChild(btn);
  });
}

dateInput.addEventListener('change', loadSlots);
tzSelect.addEventListener('change', loadSlots);
loadSlots();

bookForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!selectedStart){ alert('Select a time'); return; }
  const form = new FormData(bookForm);
  const payload = { name: form.get('name'), email: form.get('email'), start: selectedStart };
  const res = await fetch(`/api/book/${slug}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
  const data = await res.json();
  if(data.ok){
    resultEl.innerHTML = `Booked! Meet link: <a class="text-brand-700 underline" href="${data.meet_link}" target="_blank">Join</a>. Manage: <a class="text-brand-700 underline" href="${data.manage_url}">Reschedule/Cancel</a>`;
    bookForm.reset();
  }else{
    resultEl.textContent = data.error || 'Booking failed';
  }
});
</script>
{% endblock %}
